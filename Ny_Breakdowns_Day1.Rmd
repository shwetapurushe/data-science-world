---
title: "Bus_Breakdown_NY"
author: "Shweta Purushe"
date: "12/18/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(RColorBrewer)
library(leaflet)
library(rgdal)
library(sp)
library(maptools)
library(ggmap)
library(tmap)
library(tidyr)
```



```{r}
# Questions I am trying to answer for geo region analysis 

# Which Region is having the maximum incidents every year ? 
#Which incidents ? Breakdowns or Running late 

#Why? 
# is it a company problem? 
# are there too many schools being serviced 
# reason for getting late --(in the data) 

# which region has improved/ done the same/ detriorated over years 

# Which type of students are getting most affected in a region. 

# Within a region which is the best / worst company ?? 
```




```{r}
bus_df <- read_csv("/Users/spurushe/Downloads/ny-bus-breakdown-and-delays/bus-breakdown-and-delays.csv")
bus_df %>% head()

```

```{r}
# Which Region is having the maximum incidents? 

bus_df %>% 
  select(Boro, School_Year) %>% filter(!is.na(Boro), School_Year!='2019-2020') %>%
  group_by(School_Year, Boro)  %>% 
  summarise(number_in = n()) %>%
  filter(number_in == max(number_in))
```  
Looks like Bronx and Manhattan are the most affected regions across four years. 


```{r fig.width=5, fig.height=4}
#Which incidents ? Breakdowns or Running late 
affected_regions <- bus_df %>% 
  select(Boro, School_Year, Breakdown_or_Running_Late) %>% filter(!is.na(Boro), School_Year!='2019-2020') %>%
  count(School_Year, Boro, Breakdown_or_Running_Late) %>%
  rename(Num_of_Incidents = n)

affected_regions %>%
  ggplot(aes(x =Boro, y= Num_of_Incidents, fill=Breakdown_or_Running_Late)) + 
  geom_bar(stat="identity", position = "dodge") + 
  labs(x = "Region Affected", y="Number of Breakdowns", title="Regions affected") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position = "bottom") + 
  facet_wrap(~School_Year, ncol=1)

```

Hmm, as we saw above, it looks like in additon to Bronx and Manhattan, Brooklyn is a close third.  
And Bronx and Brooklyn have more number of breakdowns compared to Manhattan.


Which region has improved/ done the same/ detriorated over years?  
And all regions have improved in their services from 2015 to 2018. (reduced number of incidents)



<br/>
<br/>





### Let us now look into investigating the reasons for bus incidents  
```{r}
#Why? Answers to these questions could provide some clues. 

# Are the bus incidents a specific company problem? 
# are there too many schools being serviced ? 
# Are there too many children on the bus route? (we unfortunately dont have enough data for this)
# reason for getting late --(in the data) 



#Are the bus incidents a specific company problem? 
# Lets see the distribution of incidents across the various bus companies

bus_df %>% 
  select(Bus_Company_Name, Breakdown_or_Running_Late) %>% filter(Bus_Company_Name != '`') %>%
  group_by(Bus_Company_Name) %>% count()

```
```{r fig.width=15, fig.height=5}
# We need to clean up the bus company names a bit since the names are very nearly identical but not dont help in aggregating. For eg. ALL AMERICAN SCHOOL BUS C and ALL AMERICAN SCHOOL BUS CORP. are the same company. 
clean_bus_names <- bus_df %>% 
  select(Bus_Company_Name, Breakdown_or_Running_Late, Boro) %>% filter(Bus_Company_Name != '`', !is.na(Boro)) %>%
  mutate(Clean_BusCo_name = 
           case_when (grepl('^ALL AMERICAN SCHOOL.*', Bus_Company_Name, ignore.case = TRUE) ~ "ALL AMERICAN SCHOOL BUS CORP" ,
                      grepl('^ALL COUNTY BUS LLC.*', Bus_Company_Name, ignore.case = TRUE) ~ "ALL COUNTY BUS LLC",
                      grepl('^CAREFUL.*', Bus_Company_Name, ignore.case = TRUE) ~ "CAREFUL BUS SERVICE INC",
                      grepl('^CHILDREN`S TRANS.*', Bus_Company_Name, ignore.case = TRUE) ~ "CHILDREN`S TRANS INC",
                      grepl('^CONSOLIDATED BUS TRANS.*', Bus_Company_Name, ignore.case = TRUE) ~ "CONSOLIDATED BUS TRANS INC",
                      grepl('^Don Thomas Bus.*', Bus_Company_Name, ignore.case = TRUE) ~ "DON THOMAS BUSES INC",
                      grepl('^EMPIRE CHARTER SERVICE.*', Bus_Company_Name, ignore.case = TRUE) ~ "EMPIRE CHARTER SERVICE INC",
                      grepl('^FIRST STEPS.*', Bus_Company_Name, ignore.case = TRUE) ~ "FIRST STEPS TRANS INC",
                      grepl('^G.V.C.*|gvc', Bus_Company_Name, ignore.case = TRUE) ~ "G.V.C. LTD",
                      grepl('^HAPPY CHILD TRANS.* ', Bus_Company_Name, ignore.case = TRUE) ~ "HAPPY CHILD TRANS LLC",
                      grepl('^L & M BUS CORP.*|L&M Bus Corp', Bus_Company_Name, ignore.case = TRUE) ~ "L & M BUS CORP",
                      grepl('^LEESEL TRANS.*CORP.*', Bus_Company_Name, ignore.case = TRUE) ~ "LEESEL TRANSP CORP",
                      grepl('^LOGAN TRANSPORTATION SYST.*', Bus_Company_Name, ignore.case = TRUE) ~ "LOGAN TRANSPORTATION SYST",
                      grepl('^LORINDA ENT.*LTD.', Bus_Company_Name, ignore.case = TRUE) ~ "LORINDA ENTERPRISES LTD",
                      grepl('^MAR-CAN TRANSPORT CO.*', Bus_Company_Name, ignore.case = TRUE) ~ "MAR-CAN TRANSPORT CO INC",
                      grepl('^MJT BUS.*', Bus_Company_Name, ignore.case = TRUE) ~ "MJT BUS COMPANY INC",
                      grepl('^MONTAUK STUDENT TRANS.*', Bus_Company_Name, ignore.case = TRUE) ~ "MONTAUK STUDENT TRANS",
                      grepl('^MUTUAL BUS CORP.*', Bus_Company_Name, ignore.case = TRUE) ~ "MUTUAL BUS CORP.",
                      grepl('^NEW DAWN TRANSIT.*', Bus_Company_Name, ignore.case = TRUE) ~ "NEW DAWN TRANSIT LLC",
                      grepl('^^philli.*[p|s] BUS.*', Bus_Company_Name, ignore.case = TRUE) ~ "PHILLIP BUS CORP",
                      grepl('^PIONEER TRANSPORTATION CO.*', Bus_Company_Name, ignore.case = TRUE) ~ "PIONEER TRANSPORTATION CORP",
                      grepl('^PRIDE TRANSPORTATION.*', Bus_Company_Name, ignore.case = TRUE) ~ "PRIDE TRANSPORTATION",
                      grepl('^QUALITY TRANSPORTATION CO.*', Bus_Company_Name, ignore.case = TRUE) ~ "QUALITY TRANSPORTATION CORP",
                      grepl('^R & C TRANSIT.*', Bus_Company_Name, ignore.case = TRUE) ~ "R & C TRANSIT INC",
                      grepl('^RELIANT TRANS.*', Bus_Company_Name, ignore.case = TRUE) ~ "RELIANT TRANS INC",
                      grepl('^SAFE COACH INC.*', Bus_Company_Name, ignore.case = TRUE) ~ "SAFE COACH INC",
                      grepl('^SELBY TRANS.*', Bus_Company_Name, ignore.case = TRUE) ~ "SELBY TRANSPORTATION CORP",
                      grepl('^SMART PICK.*', Bus_Company_Name, ignore.case = TRUE) ~ "SMART PICK INC",
                      grepl('^THIRD AVENUE TRANSIT.*', Bus_Company_Name, ignore.case = TRUE) ~ "THIRD AVENUE TRANSIT INC",
                      grepl('^THOMAS BUSES.*', Bus_Company_Name, ignore.case = TRUE) ~ "THOMAS BUSES INC",
                      grepl('^TWENTY FIRST AV TRANSP.*', Bus_Company_Name, ignore.case = TRUE) ~ "TWENTY FIRST AV TRANSP",
                      grepl('^VAN TRANS.*', Bus_Company_Name, ignore.case = TRUE) ~ "VAN TRANS LLC",
                      grepl('^VINNY`S BUS SERVICES.*', Bus_Company_Name, ignore.case = TRUE) ~ "VINNY`S BUS SERVICES",
                      grepl('^Y & M TRANSIT CORP.*', Bus_Company_Name, ignore.case = TRUE) ~ "Y & M TRANSIT CORP",
                      TRUE ~ Bus_Company_Name
                      )
         ) 


## gives us the number of boros a given company services
b_s<- clean_bus_names %>%
  group_by(Clean_BusCo_name) %>%
  summarize(Boros_Serviced = paste(unique(Boro), collapse = ','), Num_Boros_Serviced = length(unique(Boro))) 



## Lets see if a relationship exists between the number of Boros serviced and the number of incidents (a reasonable thought would be more the Boros serviced, the more the incidents)

clean_bus_names %>%
          count(Clean_BusCo_name)%>% # number of incidents (breakdowns and late runnings) for a given company 
          arrange(desc(n)) %>%
  inner_join(b_s, by="Clean_BusCo_name") %>%
  ggplot(aes(x = Num_Boros_Serviced, y = n)) + 
  geom_point() + 
  labs(title ="Relationship between number of boros serviced by a company with the number of incidents", x="Number of Boros Serviced", y="Number of Incidents") +
  scale_x_discrete(limits=seq(1:12))



```


Looks like barring a few outliers, there seems to be a positive relationship. There, across all the years, the more the boros a company plies to, meaning the more the extent a company's buses traverse, the higher the number of incidents they have.






```{r}
# Number of breakdowns per geo region 
# label should be the number of kids and schools affected in the area. 
bus_df %>% 
  filter(Bus_Company_Name != "") %>%
  select(Boro, Schools_Serviced, Number_Of_Students_On_The_Bus) %>%
  tidyr::separate(Schools_Serviced, into=c("NewSS", "NewSS2"), sep=",", remove=FALSE)
```




```{r}
#2. Performance over years of a company. 
# counts of breakdowns
# reason for breakdown and relationship with number of students 

(breakdowns <- bus_df %>%
   select(Boro, School_Year, Reason , Breakdown_or_Running_Late) %>%
   filter(School_Year != '2019-2020')%>%
   count(School_Year, Boro,Breakdown_or_Running_Late, Reason) %>%
   rename(Num_of_Incidents = n)
   )

```


```{r}
(num_students <- bus_df %>% 
  select(Boro,Breakdown_or_Running_Late, Number_Of_Students_On_The_Bus) %>%
  count(Boro,Breakdown_or_Running_Late)) %>%
  dplyr::rename(Number_of_Students_Affected = n)
```


```{r}
(students_affected <- breakdowns %>% 
                      filter(!is.na(Boro)) %>%
                      inner_join(num_students, by=c("Boro" = "Boro", "Breakdown_or_Running_Late" = "Breakdown_or_Running_Late")) %>%
                      rename(Students_Affected = n)
 )

```

```{r fig.width=5, fig.height=4}
 g <-  students_affected %>%
                ggplot(aes(x=Boro, y= Num_of_Incidents, fill=Reason)) +
                geom_bar(stat = "identity") +
                labs(x = "Region Affected", y="Number of Breakdowns", title="Regions affected") +
                 theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position="bottom") +
                scale_fill_brewer(palette="BrBG") +
                #####
                #geom_point(aes(x=Boro, y=Students_Affected)) +
                #geom_line(aes(x=Boro, y=Students_Affected)) +
                #scale_y_continuous(sec.axis = sec_axis(~.*0.01, name = "Students_Affected")) +
                facet_wrap(~Breakdown_or_Running_Late, ncol=2)
g
 
```

<br/>
<br/>

The goal here is to compare the concerned geographic regions (boroughs, counties and states) with respect to the number of the bus 'incidents'. An incident would be any deviation from normal operation i.e. either breakdown or running late.  
However, the number of breakdown incidents is an absolute metric. The number of incidents directly depends on the number of buses plying to that region, which in turn depends on the area of the region. We assume that larger the area to be convered, the more the number of buses and possibly higher the number of bus incidents.  
It will be incorrect to compare the number of incidents in a region with many buses with one having a smaller number of buses.  
Therefore we should normalize the bus incidents by the area of that spatial polygon 



```{r}
## BUSES PLYING
# county with maximum incidents / # of buses plying
# buses_plying <- bus_df %>% 
#                 filter(!is.na(Boro)) %>%
#                 select(School_Year, Boro , Bus_Company_Name, Bus_No) %>% # using bus company because two companies could have the same bus id 
#                 count(School_Year, Boro) %>% 
#                 rename(Num_of_buses = n)



## SCHOOLS SERVICED
cleaned_schools <- bus_df %>%
                    #filter(School_Year == '2016-2017') %>%
                    select(Boro, Schools_Serviced, School_Year) %>%
                    separate_rows(Schools_Serviced, sep=",| |/", convert=TRUE) %>%
                    filter(Schools_Serviced != '') %>% # some have commas followed by a space for eg "10234, "
                    filter(!is.na(Boro)) 

num_sc <- cleaned_schools %>% 
  group_by(School_Year, Boro) %>% 
  mutate(Num_Schools = n_distinct(Schools_Serviced)) %>% 
  distinct(Num_Schools)
  

num_of_in <- bus_df %>% 
  select(Boro, School_Year, Breakdown_or_Running_Late) %>%
  count(Boro, School_Year) %>% rename(Num_of_incidents = n)


num_sc %>% 
  inner_join(num_of_in, by=c("Boro", "School_Year")) %>%
  filter(School_Year != '2019-2020') %>%
  ggplot(aes(x=Num_Schools, y = Num_of_incidents)) + geom_point()  + facet_wrap(~Boro)
```














```{r}
#3. counties and routes with maxiumum schools affected 

(places <- bus_df %>% select(Boro)%>%unique() %>% filter(Boro != 'All Boroughs' & !is.na(Boro)))
```

```{r}
#https://www1.nyc.gov/site/planning/data-maps/open-data/districts-download-metadata.page
ny_boros <- readOGR("/Users/spurushe/Downloads/nybb_18d/nybb.shp")


#https://www.census.gov/geo/maps-data/data/cbf/cbf_counties.html
ny_counties <- readOGR("/Users/spurushe/Downloads/cb_2017_us_county_20m/cb_2017_us_county_20m.shp")
## Rockland
rockland_c <- ny_counties$NAME == "Rockland" & ny_counties$STATEFP == "36" & ny_counties$COUNTYFP == "087"
rc_ex <- ny_counties[rockland_c, ]

## Nassau
nassau_c <- ny_counties$NAME == "Nassau" & ny_counties$STATEFP == "36" & ny_counties$COUNTYFP == "059"
ns_ex <- ny_counties[nassau_c, ]

## Westchester 
westchester_c <- ny_counties$NAME == "Westchester" & ny_counties$STATEFP == "36" & ny_counties$COUNTYFP == "119"
ws_ex <- ny_counties[westchester_c, ]




#extracting one state from all states shape file
all_states <- readOGR("/Users/spurushe/Downloads/cb_2017_us_state_20m/cb_2017_us_state_20m.shp")
names(all_states) 
all_states[["NAME"]] # use this to find the index of the state you want 


#Connecticut
con <- all_states$NAME == "Connecticut"
con_ex <- all_states[con, ] #extract connecticut

#New Jersey 
nj <- all_states$NAME == "New Jersey"
nj_ex <- all_states[nj, ]

```

```{r}
affected_regions%>%filter(Boro == 'Connecticut', School_Year == '2015-2016')

## Getting areas of all the geo regions
reg <- c(rc_ex, ns_ex, ws_ex, con_ex, nj_ex) # excluding ny_boros due to the method of extraction using shape files

areas <- sapply(reg, gArea)
names <- sapply(reg, function(x){slot(x, "data")$NAME})

d <- data.frame(BoroName = names, Shape_Area = areas)
rownames(d) <- NULL

# ny_area <- slot(ny_boros, "data")[, c("BoroName", "Shape_Area")]
# rownames(ny_area) <- NULL
```


```{r}
# adding the respective data to the corresponding geo regions

x = affected_regions %>% 
  filter(!Boro %in% c("New Jersey", "Connecticut", "Westchester", "Rockland County", "Nassau County", "All Boroughs"))
         
         
ny_data <- sp::merge(ny_boros, x, by.x = "BoroName", by.y = "Boro", duplicateGeoms = TRUE)

```



```{r}
all <-  tm_shape(ny_data) + tm_borders() + tm_fill("incidents_by_buses", n= 10) + tm_text("BoroName")
        # tm_shape(con_ex) + tm_borders() + 
        # tm_shape(nj_ex) + tm_borders() + 
        # tm_shape(rc_ex) + tm_borders() + 
        # tm_shape(ns_ex) + tm_borders() + 
        # tm_shape(ws_ex) + tm_borders()
all
ttm()
```


```{r}
#Junk code

# bus_df %>% 
#   #filter(!grepl("[0-9]|'", Bus_Company_Name)) %>% 
#   select(Bus_Company_Name, How_Long_Delayed) %>%
#   mutate(new_delay = as.numeric(gsub("[a-z]|[A-Z]",'', How_Long_Delayed))) %>%
#   group_by(Bus_Company_Name) %>%
#   summarize(avg_delay = mean(new_delay, na.rm = TRUE)) %>% 
#   filter(is.nan(avg_delay))



# bus_df %>%
#   filter(School_Year == '2015-2016')%>%
#   mutate(ex = substr(Bus_Company_Name,0, 10)) %>%
#   #select(Bus_Company_Name, ex) %>%
#   count(ex)







#merged_shp <- raster::union(ny_boros, rc_ex) %>% union( con_ex) %>%union( ns_ex) %>% union( nj_ex) %>% union( ws_ex) # way to merge two shape files


#m <- leaflet() %>%
#addTiles() %>%  # Add default OpenStreetMap map tiles
#addMarkers(lng=geo_data$lon, lat=geo_data$lat, popup="The birthplace of R")
```

